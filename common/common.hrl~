%%%-------------------------------------------------------------------
%%% @author adoor balasubramanian <balu@localhost.localdomain>
%%% @copyright (C) 2014, adoor balasubramanian
%%% @doc
%%%
%%% @end
%%% Created : 28 Dec 2014 by adoor balasubramanian <balu@localhost.localdomain>
%%%-------------------------------------------------------------------
% -define(dbg(L), error_logger:info_report(debug_message, 
%					[{module, ?MODULE},
%					{line, ?LINE} | L])).
-define(dbg(L), io:format("~p:~p : ~p~n", [?MODULE, ?LINE, L])).
-define(IP_MIN_HDR_LEN, 5).
-define(IP_PROTO_TCP, 6).
-define(TCP_MIN_HDR_LEN, 20).
-define(MSG_TIMEOUT, 8000). % 8s
-type error_code() :: normal | 
		      no_syn_ack |
		      no_ack_syn_ack |
		      no_client_request |
		      no_server_response.

-type end_cause() :: timeout |
		     c_fin |
		     s_fin |
		     c_rst |
		     s_rst.

-type time() :: {Seconds :: non_neg_integer(),
		 Micro :: non_neg_integer()}.

%-type perf() :: {#timeStamp{}, integer()}.
-type ip_address() :: binary().

-type host() :: client() | server().

-type http_response_code() :: pos_integer().


-type client() :: ip_address().
-type server() :: ip_address().

-type latency()    :: integer(). % in microseconds

-type config_object() :: atom().

%% @doc 
%% time relative to session start time (t - t-start)
%% unit is microseconds
%-type relative_#timeStamp{} :: integer().

%% @doc session
%% @doc session
%% TCP session


-record(session, {server   :: server(),
		  port  :: pos_integer(),
		  client :: client()
		 }
       ).
			      

-record(five_tuple, {sip :: ip_address(),
		     dip :: ip_address(), 
		     proto :: ?IP_PROTO_TCP, 
		     sp :: pos_integer(), 
		     dp :: pos_integer()}).

-record(syn_msg, { sender :: pid(),
			session_key :: tuple(),
			ts :: time(),
			five_tuple :: tuple(),
			seq :: integer(),
			frame :: binary() % whole frame as captured
	}).

-record(msg, 
	{ sender :: pid(),
	  session_key :: tuple(),
	  ts :: time(), % { seconds, microseconds}
	  len  :: pos_integer(), % actual length on the wire
	  five_tuple :: tuple(),
	  pdu :: binary(),
	  frame :: binary() % whole frame as captured
	}).

%%% @ doc perf record
%%%  rx_bytes, rx_frames are logged against the request time
%%%  tx_bytes, tx_frames are logged against the response time
%%% TCP control packets are not included in the above

	  
% @doc transaction
% Here t_start is time relative to (session start time)
% hence the type sepc integer() instead of #timeStamp{}

-record(transaction, { 
	  t_start :: time(), 
	  latency  :: latency(),
	  rx_bytes = 0 :: non_neg_integer(),
	  rx_frames = 0 :: non_neg_integer(),
	  tx_bytes = 0 :: non_neg_integer(),
	  tx_frames = 0 :: non_neg_integer(),
	  response_code :: normal | integer(),
	  retrans = 0 :: integer() % req retransmissions
	 }).

% @doc session_update
% message sent from session to admin
% syn_retrans : The idea is to see if
% any large connection setup delay is due to SYN packet loss
% latenct = t_syn_ack - t_syn

-record(session_update, {
	  session :: #session{},
	  t_start :: time(),
	  latency :: latency(),
	  t_end :: time(),
	  end_cause :: end_cause(),
	  error_code :: error_code(),
	  syn_retrans = 0 :: non_neg_integer(),
	  transactions = [] :: [#transaction{}],
	  frames :: [binary()]
	 }).

